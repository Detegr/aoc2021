Dâ†{
  ğ•¨ğ•ŠâŸ¨âŸ¨l1,r1âŸ©,âŸ¨l2,r2âŸ©âŸ©: (ğ•¨+1 D âŸ¨l1, r1âŸ©)âˆ¾ğ•¨+1 D âŸ¨l2,r2âŸ© ;
  ğ•¨ğ•ŠâŸ¨âŸ¨l1,r1âŸ©,râŸ©: ((ğ•¨+1) D âŸ¨l1,r1âŸ©)âˆ¾ğ•¨ ;
  ğ•¨ğ•ŠâŸ¨l,âŸ¨l2,r2âŸ©âŸ©: ğ•¨âˆ¾(ğ•¨+1) D âŸ¨l2,r2âŸ© ;
  ğ•¨ğ•ŠâŸ¨l,râŸ©: âŸ¨ğ•¨,ğ•¨âŸ©
}

Preprocessâ†{
  ğ•©â†©â€¢BQN "[]"{(ğ•˜âŠËœğ•—âŠ¸âŠ)âŒ¾((ğ•©âˆŠğ•—)/â—‹â¥ŠâŠ¢)ğ•©}"âŸ¨âŸ©" ğ•©
  depthsâ†0 D ğ•©
  maxdâ†âŒˆÂ´depths
  âŸ¨depths,âˆ¾âŸmaxd ğ•©âŸ©
}

Explode â† {ğ•Šdepthsâ€¿values:
  depths {3âˆ¾ğ•©âˆ¾3}â†©
  values {âˆâˆ¾ğ•©âˆ¾âˆ}â†©
  iâ†âŠ‘/â‰¡âŸœ4â€¿4Ë˜2â†•depths
  mâ†(1-Ëœâ‰ values)â†‘/â¼â‹ˆi
  m2â†m+(Â¯1âŒ½m)âˆ¨(1âŒ½m)
  sumsâ†+Â´Ë˜2â†•values
  values (Â¬mâˆ¾0)âŠ¸/â†©
  depths (Â¬mâˆ¾0)âŠ¸/â†©
  depths -âŸœ1âŒ¾(mâŠ¸/)â†©
  depths â†© 1â†“Â¯1â†“depths
  râ†1â€¿0â€¿1Ã—m2/sums
  valuesâ†©(râŒ¾(m2âŠ¸/) values)
  valuesâ†©1â†“Â¯1â†“values
  depthsâ€¿values
}

Split â† {ğ•Šdepthsâ€¿values:
  iâ†âŠ‘/Â¬(valuesâ‰¥10)âŠ’Ëœâ‹ˆ1
  vâ†2Ã·ËœiâŠ‘values
  vâ†©âŸ¨âŒŠv,âŒˆvâŸ©
  dâ†iâŠ‘depths+1
  valuesâ†©âˆ¾vâŒ¾(iâŠ¸âŠ‘) values
  depthsâ†©âˆ¾âŸ¨d,dâŸ©âŒ¾(iâŠ¸âŠ‘) depths
  âŸ¨depths, valuesâŸ©
}

ReduceStep â† {ğ•Šdepthsâ€¿values:
  eâ†0<+Â´â‰¡âŸœ4â€¿4Ë˜2â†•depths
  sâ†2Ã—+Â´Â¬(valuesâ‰¥10)âŠ’Ëœâ‹ˆ1

  (eâˆ¨s)â—¶âŠ¢â€¿Explodeâ€¿Split depthsâ€¿values
}

Reduce â† ReduceStep {ğ•Šâˆ˜âŠ¢âŸâ‰¢âŸœğ”½ğ•©}

Add â† {âŸ¨ad,avâŸ©ğ•ŠâŸ¨bd,bvâŸ©: Reduce âŸ¨(1+adâˆ¾bd),avâˆ¾bvâŸ© }

MagStep â† {ğ•ŠâŸ¨depths,valuesâŸ©:
  maxdâ†âŒˆÂ´depths
  mâ†(maxd=depths)
  m2â†(â‰ depths)â†‘/â¼(Â¬2|â†•âˆ˜â‰ )âŠ¸/âˆ˜/m
  valsâ†âˆ˜â€¿2â¥Šm/values
  valsâ†©{(3Ã—(âŠ‘ğ•©))+2Ã—(1âŠ‘ğ•©)}Ë˜vals
  valuesâ†©valsâŒ¾(m2âŠ¸/) values
  m3â†Â¬Â¯1âŒ½m2
  âŸ¨(m3/depths)-m3/m,m3/valuesâŸ©
}

Mag â† {ğ•Š: âŠ‘1âŠ‘MagStepâŸ(1+âŒˆÂ´âŠ‘ğ•©) ğ•© }

input â† PreprocessÂ¨â€¢FLines "inputs/input18"

# star 1
â€¢Show Mag Â¯1âŠ‘Add`input

# star 2
â€¢Show âŒˆÂ´âŒˆËMagÂ¨Ë˜AddÂ´Â¨Ë˜â‹ˆâŒœËœinput
